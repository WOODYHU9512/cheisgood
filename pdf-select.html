<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // ✅ 初始化 Firebase
    const firebaseConfig = {
      databaseURL: "https://access-7a3c3-default-rtdb.firebaseio.com/"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let authorizedSchools = [];

    // ✅ 學校對應的科目與 Google Drive PDF File ID
    const subjects = {
      "台大": {
        "106~114 台大單操輸送": "1-8YNZiVw81RjqLPPWmzbC0ng4PAIa53a",
        "106~114 台大化熱化反": "1V1xIOMRl04VJORV4fdKN9Bot76XRnv7A",
        "106~114 台大工數": "1twqzBEGA7A3YEzYLRf-kDcLqBkOS4ujD"
      },
      "清大": {
        "106~114 清大單操輸送": "1oDoN0B7hpQEvy9MGDrZvkv7v2ow6NRoj",
        "106~114 清大化熱化反": "14LTMKQmev5gKYjy84RceAq6b-AK_9hTE"
      },
      "成大": {
        "106-114 成大單操輸送": "1Z6dWhVPKlpjQVQLOMl73QCNmLYod7CtY",
        "106-114 成大化熱": "1YlWIhNIbxILLLSyU0cH9NL6-6oUeWBpu",
        "106-114 成大化反": "1DFrKbo-9uD-i4e4ipeh3XbX-tgeVEb1Y"
      },
      "中央": {
        "106~114 中央單操輸送": "1sKb01AvjaKl4z-Ch0TyqXKahVhMUA1iE",
        "106~114 中央化熱化反": "1yN5N4_0B64YtvTmdobnOuJs1mXASH5Xd"
      },
      "台科大": {
        "106-114 台科大工數與單操輸送": "1dq3RAcKUkR4LvZTjDIE1fMFRJ3Vc4346",
        "106~114 台科大化熱化反": "1rDYx5rR6an3Xg8FQaWan-zqjhovWsn-H"
      },
      "中興": {
        "106-114 中興工程數學與輸送現象": "1AREZvc7hVtVHGpG7qwoZkRVD96ljlcXt",
        "106-114 中興化熱化反": "1uYHa87G9aoc9VnyVjeXJPgVnVKPI_ujS"
      }
    };

    // ✅ 讀取使用者權限
    async function loadUserPermissions() {
      const username = localStorage.getItem('loggedInUser');
      if (!username) {
        alert("❌ 未登入，請重新登入！");
        window.location.href = "index.html";
        return;
      }

      const userRef = ref(db, `users/${username}/purchased`);
      const snapshot = await get(userRef);

      if (snapshot.exists() && snapshot.val() !== null) {
        authorizedSchools = Object.keys(snapshot.val()); // ✅ 取出 purchased 的 key 當成陣列
      } else {
        authorizedSchools = [];
      }

      console.log("✅ 你有權限的學校：", authorizedSchools);
      populateSchoolOptions();
    }

    // ✅ 顯示使用者擁有的學校
    function populateSchoolOptions() {
      const schoolSelect = document.getElementById("schoolSelect");
      schoolSelect.innerHTML = "<option value=''>請選擇學校</option>";

      authorizedSchools.forEach(school => {
        let option = document.createElement("option");
        option.value = school;
        option.textContent = school;
        schoolSelect.appendChild(option);
      });
    }

    // ✅ 更新科目下拉選單
    function updateSubjects() {
      const school = document.getElementById("schoolSelect").value;
      const subjectSelect = document.getElementById("subjectSelect");

      subjectSelect.innerHTML = "<option value=''>請選擇科目</option>";

      if (school && subjects.hasOwnProperty(school)) {
        Object.keys(subjects[school]).forEach(subject => {
          let option = document.createElement("option");
          option.value = subjects[school][subject]; // ✅ 存 Google Drive File ID
          option.textContent = subject;
          subjectSelect.appendChild(option);
        });
      } else {
        console.error(`❌ 沒有找到對應的科目資料：${school}`);
      }
    }

    // ✅ 選擇 PDF 進入 viewer
    function viewPDF() {
      const subjectId = document.getElementById("subjectSelect").value;

      if (!subjectId) {
        alert("❌ 請選擇科目！");
        return;
      }

      localStorage.setItem("currentPDF", subjectId);
      window.location.href = "pdf-viewer.html";
    }

    loadUserPermissions();
</script>
