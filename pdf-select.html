<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <script type="module" src="https://raw.githubusercontent.com/WOODYHU9512/cheisgood/main/script.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¸æ“‡å­¸æ ¡èˆ‡ç§‘ç›®</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    select, button {
      margin: 10px;
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h2>è«‹é¸æ“‡å­¸æ ¡èˆ‡ç§‘ç›®</h2>
  
  <!-- å­¸æ ¡é¸æ“‡ -->
  <label for="schoolSelect">é¸æ“‡å­¸æ ¡ï¼š</label>
  <select id="schoolSelect" onchange="updateSubjects()">
    <option value="">è«‹é¸æ“‡å­¸æ ¡</option>
    <option value="å°å¤§">å°å¤§</option>
    <option value="æ¸…å¤§">æ¸…å¤§</option>
    <option value="æˆå¤§">æˆå¤§</option>
    <option value="ä¸­å¤®">ä¸­å¤®</option>
    <option value="å°ç§‘å¤§">å°ç§‘å¤§</option>
    <option value="ä¸­èˆˆ">ä¸­èˆˆ</option>
  </select>

  <!-- ç§‘ç›®é¸æ“‡ -->
  <label for="subjectSelect">é¸æ“‡ç§‘ç›®ï¼š</label>
  <select id="subjectSelect">
    <option value="">è«‹å…ˆé¸æ“‡å­¸æ ¡</option>
  </select>

  <button onclick="viewPDF()">è§€çœ‹ PDF</button>

  <!-- ğŸ”¥ ç™»å‡ºæŒ‰éˆ• -->
  <button onclick="logout()" style="
  position: fixed; 
  top: 10px; 
  right: 10px; 
  padding: 10px 15px; 
  background-color: red; 
  color: white; 
  border: none; 
  cursor: pointer;
  font-size: 16px;
">
  ğŸšª ç™»å‡º
</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // ğŸš€ åˆå§‹åŒ– Firebase
    const firebaseConfig = {
      databaseURL: "https://access-7a3c3-default-rtdb.firebaseio.com/"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // âœ… ç§‘ç›®è³‡æ–™
    const subjects = {
      "å°å¤§": ["106~114 å°å¤§å–®æ“è¼¸é€", "106~114 å°å¤§åŒ–ç†±åŒ–å", "106~114 å°å¤§å·¥æ•¸"],
      "æ¸…å¤§": ["106~114 æ¸…å¤§å–®æ“è¼¸é€", "106~114 æ¸…å¤§åŒ–ç†±åŒ–å"],
      "æˆå¤§": ["106-114 æˆå¤§å–®æ“è¼¸é€", "106-114 æˆå¤§åŒ–ç†±", "106-114 æˆå¤§åŒ–å"],
      "ä¸­å¤®": ["106~114 ä¸­å¤®å–®æ“è¼¸é€", "106~114 ä¸­å¤®åŒ–ç†±åŒ–å"],
      "å°ç§‘å¤§": ["106-114 å°ç§‘å¤§å·¥æ•¸èˆ‡å–®æ“è¼¸é€", "106~114 å°ç§‘å¤§åŒ–ç†±åŒ–å"],
      "ä¸­èˆˆ": ["106-114 ä¸­èˆˆå·¥ç¨‹æ•¸å­¸èˆ‡è¼¸é€ç¾è±¡", "106-114 ä¸­èˆˆåŒ–ç†±åŒ–å"]
    };

    // âœ… æ›´æ–°ç§‘ç›®é¸å–®
    window.updateSubjects = function() {
      const school = document.getElementById("schoolSelect").value;
      const subjectSelect = document.getElementById("subjectSelect");

      subjectSelect.innerHTML = "<option value=''>è«‹é¸æ“‡ç§‘ç›®</option>";

      if (school && subjects[school]) {
        subjects[school].forEach(subject => {
          let option = document.createElement("option");
          option.value = subject;
          option.textContent = subject;
          subjectSelect.appendChild(option);
        });
      }
    };

    // âœ… æª¢æŸ¥æ˜¯å¦æœ‰é¸æ“‡ç§‘ç›®
    window.viewPDF = function() {
      const subject = document.getElementById("subjectSelect").value;

      if (!subject) {
        alert("è«‹é¸æ“‡ç§‘ç›®ï¼");
        return;
      }

      localStorage.setItem("currentPDF", subject);
      window.location.href = "pdf-viewer.html";
    };

    // âœ… ç™»å‡ºåŠŸèƒ½
    window.logout = async function() {
      const username = localStorage.getItem('loggedInUser');
      const storedToken = localStorage.getItem('sessionToken');

      if (!username) return;

      try {
        const userRef = ref(db, "users/" + username);
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
          const user = snapshot.val();

          if (user.sessionToken === storedToken) {
            await update(userRef, {
              isLoggedIn: false,
              sessionToken: ""
            });
            console.log(`ğŸšª ${username} å·²ç™»å‡ºï¼`);
          }
        }
      } catch (error) {
        console.error("âŒ ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
      }

      localStorage.removeItem('loggedInUser');
      localStorage.removeItem('sessionToken');
      window.location.href = 'index.html';
    };

    // âœ… è¨ˆæ™‚å™¨ï¼š10 ç§’å¾Œè‡ªå‹•ç™»å‡ºï¼ˆå¯èª¿æ•´æ™‚é–“ï¼‰
    const IDLE_TIME_LIMIT = 10 * 1000; // 10 ç§’æ¸¬è©¦ç‰ˆ
    let idleTimeout;

    function startIdleTimer() {
      console.log("â³ é–’ç½®è¨ˆæ™‚å™¨é‡è¨­...");
      clearTimeout(idleTimeout);

      // âœ… è¨˜éŒ„æ™‚é–“åˆ° localStorageï¼Œè®“æ‰€æœ‰é é¢åŒæ­¥è¨ˆæ™‚
      localStorage.setItem("lastActivity", Date.now());

      idleTimeout = setTimeout(() => {
        console.log("â° é–’ç½®è¶…é 10 ç§’ï¼Œè‡ªå‹•ç™»å‡ºï¼");
        alert("æ‚¨å·²é–’ç½® 10 ç§’ï¼Œå°‡è‡ªå‹•ç™»å‡ºï¼");
        logout();
      }, IDLE_TIME_LIMIT);
    }

    // ğŸ”¥ ç›£è½ä½¿ç”¨è€…æ´»å‹•ä¾†é‡è¨­è¨ˆæ™‚å™¨
    document.addEventListener("mousemove", startIdleTimer);
    document.addEventListener("keydown", startIdleTimer);
    document.addEventListener("touchstart", startIdleTimer);

    // âœ… ç›£è½ localStorage è®ŠåŒ–ï¼Œç¢ºä¿å…¶ä»–é é¢æœ‰æ´»å‹•æ™‚ä¹Ÿæœƒé‡è¨­è¨ˆæ™‚å™¨
    window.addEventListener("storage", (event) => {
      if (event.key === "lastActivity") {
        console.log("ğŸ”„ åµæ¸¬åˆ°å…¶ä»–é é¢æœ‰æ´»å‹•ï¼Œé‡è¨­è¨ˆæ™‚å™¨ï¼");
        startIdleTimer();
      }
    });

    // âœ… æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    function checkLoginStatus() {
      const username = localStorage.getItem('loggedInUser');
      const sessionToken = localStorage.getItem('sessionToken');

      if (!username || !sessionToken) {
        console.log("â›” æœªç™»å…¥ï¼Œè·³è½‰è‡³ç™»å…¥é é¢");
        window.location.href = 'index.html';
      }
    }

    // âœ… å•Ÿå‹•è¨ˆæ™‚å™¨èˆ‡ç™»å…¥æª¢æŸ¥
    checkLoginStatus();
    startIdleTimer();
  </script>

</body>
</html>
